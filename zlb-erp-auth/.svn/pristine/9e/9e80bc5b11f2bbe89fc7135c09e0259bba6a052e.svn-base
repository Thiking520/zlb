<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhilianbao.erp.auth.mapper.goods.GoodsConversionRateMapper">
  <resultMap id="goodsConversionRateResultVoMap" type="com.zhilianbao.erp.auth.vo.goods.conversion.GoodsConversionRateVo">
    <!--
      WARNING - @mbggenerated
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="goods_mode" jdbcType="SMALLINT" property="goodsMode" />
    <result column="goods_id" jdbcType="VARCHAR" property="goodsId" />
    <result column="sku_id" jdbcType="BIGINT" property="skuId" />
    <result column="relate_original_good" jdbcType="BIGINT" property="relateOriginalGood" />
    <result column="conversion_rate" jdbcType="DECIMAL" property="conversionRate" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="creator" jdbcType="BIGINT" property="creator" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="modifier" jdbcType="BIGINT" property="modifier" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
    -->
    id, goods_mode, goods_id, sku_id, relate_original_good, conversion_rate, create_time, 
    creator, update_time, modifier
  </sql>
  
  <!-- 多规格商品转换率详细，每个规格包含规格下的原始商品转换率集合。  -->
  <resultMap id="goodsConversionRateResultMap" type="com.zhilianbao.erp.auth.vo.goods.conversion.GoodsConversionRateResultVo" >
    <id column="id" property="id" jdbcType="BIGINT" />
  	<result column="goods_id" property="goodsId" jdbcType="BIGINT" />
  	<result column="record_id" property="recordId" jdbcType="BIGINT" />
  	<result column="sku_subtitle" property="skuSubtitle" jdbcType="VARCHAR" />
  	
    <!-- t_goods_sku_recode表 -->
  	<collection property="skuList" javaType="ArrayList" column="record_id" ofType="com.zhilianbao.erp.auth.vo.goods.GoodsSkuRecodeVo" select="getSkuRecodeList" >
	</collection>
	
	<!-- 
		根据商品编号goods_id查询t_goods_conversion_rate表所有所属改id的原始商品的转换信息
	 -->
	<collection property="conversionRateList" javaType="ArrayList" column="id" ofType="com.zhilianbao.erp.auth.vo.goods.conversion.GoodsConversionRateVo" select="getGoodsConversionRateList" >
	</collection>
  </resultMap>
  
  
  
  <!-- t_goods_sku_recode -->
  <resultMap id="goodsSkuRecodeMap" type="com.zhilianbao.erp.auth.vo.goods.GoodsSkuRecodeVo" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="parent_id" property="parentId" jdbcType="BIGINT" />
    <result column="sku_id" property="skuId" jdbcType="BIGINT" />
    <result column="sku_name" property="skuName" jdbcType="VARCHAR" />
    <result column="skuParentId" property="skuParentId" jdbcType="VARCHAR" />
    
  </resultMap>
  
  <!-- 多规格商品：根据商品id查询多规格列表，列表包含规格下原始商品转换率详情列表。 -->
  <select id="goodsConversionAndRecordRateByGoodsId" resultMap="goodsConversionRateResultMap">
  	SELECT id,goods_id, record_id,goods_stock_id,sku_store,sku_subtitle
	FROM t_goods_sku_list
	<where>     
        <if test="goodsId!=null and goodsId!='' ">
        	goods_id = #{goodsId} 
        </if>
    </where>
  </select>
  
  <!-- 单品商品：根据商品id查询原始商品转换率详情列表。 -->
  <select id="singleGoodsConversionByGoodsId" parameterType="com.zhilianbao.erp.auth.vo.goods.conversion.GoodsConversionRateVo"
   resultMap="goodsConversionRateResultVoMap">
  	select rate.id, goods_mode, goods_id,o.goods_name relateOriginalGoodName, 
	rate.sku_id, rate.relate_original_good, rate.conversion_rate, rate.create_time, 
    rate.creator, rate.update_time, rate.modifier
    FROM t_goods_conversion_rate rate
	INNER JOIN t_goods_original o ON o.id=rate.relate_original_good
	WHERE rate.goods_id=#{goodsId}
  </select>
  
  <select id="getSkuRecodeList" resultMap="goodsSkuRecodeMap" >
	SELECT recode.id, recode.parent_id, recode.sku_id, sku.sku_name, sku.parent_id skuParentId FROM t_goods_sku_recode recode 
	LEFT JOIN t_goods_sku sku on sku.id = recode.sku_id
	WHERE recode.parent_id = #{record_id}
  </select>
  
  <select id="getGoodsConversionRateList" resultMap="goodsConversionRateResultVoMap" >
	select rate.id, goods_mode, goods_id,o.goods_name relateOriginalGoodName, 
	rate.sku_id, rate.relate_original_good, rate.conversion_rate, rate.create_time, 
    rate.creator, rate.update_time, rate.modifier
    FROM t_goods_conversion_rate rate
	INNER JOIN t_goods_original o ON o.id=rate.relate_original_good
	WHERE sku_id=#{id}
  </select>
  
  <!-- 根据规格id，查询该规格信息以及下所有原始商品转换率明细。 -->
  <select id="getGoodsConversionRateListBySkuId" resultMap="goodsConversionRateResultMap" >
	SELECT id,goods_id, record_id,goods_stock_id,sku_store,sku_subtitle
	FROM t_goods_sku_list
	<where> 
        <if test="skuId!=null and skuId!=0 ">
        	id=#{skuId}
        </if>  
    </where>
  </select>
  <!-- 
  	新增单品或者多规格商品的原始商品，新增后，id通过引用传递保存到传入的参数中，外面通过传入的实体对象调用getId()方法可得到新增后的id。
   -->
  <insert id="insertAndGetId" useGeneratedKeys="true" keyProperty="id" parameterType="com.zhilianbao.erp.auth.entity.goods.conversion.GoodsConversionRateBean">  
    insert into t_goods_conversion_rate(goods_mode, goods_id, 
    <if test="skuId!=null and skuId !=''">
    sku_id,
    </if>
    relate_original_good, conversion_rate, creator)  
    values(#{goodsMode}, #{goodsId}, 
    <if test="skuId!=null and skuId !=''">
    #{skuId},
    </if>
    #{relateOriginalGood}, #{conversionRate}, #{creator})  
  </insert> 
</mapper>