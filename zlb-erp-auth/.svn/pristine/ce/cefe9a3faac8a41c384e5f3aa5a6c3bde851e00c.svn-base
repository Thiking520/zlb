<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhilianbao.erp.auth.mapper.goods.GoodsMapper" >
  <resultMap id="BaseResultMap" type="com.zhilianbao.erp.auth.vo.goods.GoodsVo" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="goods_type" property="goodsType" jdbcType="BIGINT" />
    <result column="goods_code" property="goodsCode" jdbcType="VARCHAR" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="slave_title" property="slaveTitle" jdbcType="VARCHAR" />
    <result column="goods_mode" property="goodsMode" jdbcType="SMALLINT" />
    <result column="goods_desc" property="goodsDesc" jdbcType="VARCHAR" />
    <result column="sort_index" property="sortIndex" jdbcType="INTEGER" />
    <result column="operator_id" property="operatorId" jdbcType="BIGINT" />
    <result column="goods_status" property="goodsStatus" jdbcType="INTEGER" />
    <result column="goods_image_url" property="goodsImageUrl" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="creator" property="creator" jdbcType="BIGINT" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="modifier" property="modifier" jdbcType="BIGINT" />
    <result column="deleted" property="deleted" jdbcType="BIT" />
  </resultMap>
  
  <resultMap id="DetailsResultMap" type="com.zhilianbao.erp.auth.vo.goods.GoodsVo" >
  	<id column="id" property="id" jdbcType="BIGINT" />
  	<result column="type_id" property="typeId" jdbcType="VARCHAR" />
  	<result column="type_name" property="typeName" jdbcType="VARCHAR" />
  	<result column="goods_code" property="goodsCode" jdbcType="VARCHAR" />
  	<result column="title" property="title" jdbcType="VARCHAR" />
    <result column="slave_title" property="slaveTitle" jdbcType="VARCHAR" />
    <result column="goods_mode" property="goodsMode" jdbcType="SMALLINT" />
  	<result column="goods_desc" property="goodsDesc" jdbcType="VARCHAR" />
    <result column="sort_index" property="sortIndex" jdbcType="INTEGER" />
    <result column="goods_image_url" property="goodsImageUrl" jdbcType="VARCHAR" />
    
    <collection property="tagList" javaType="ArrayList" column="id" ofType="com.zhilianbao.erp.auth.vo.goods.GoodsTagVo" select="getTagList" >
	</collection>
  </resultMap>
  
  <resultMap id="TagResultMap" type="com.zhilianbao.erp.auth.vo.goods.GoodsTagVo">  
   	<id column="id" property="id" jdbcType="BIGINT" />
    <result column="tag_name" property="tagName" jdbcType="VARCHAR" />
  </resultMap>
  
  
  <sql id="Base_Column_List" >
    id, goods_type, goods_code, title, slave_title, goods_mode, goods_desc, sort_index, 
    operator_id, goods_status, goods_image_url, create_time, creator, update_time, modifier, 
    deleted
  </sql>
  
  <!-- 分页查询 -->
  <select id="queryGoodsListByPage" resultMap="BaseResultMap">
  	SELECT goods.* FROM (SELECT <include refid="Base_Column_List" /> FROM t_goods) goods
  	left join t_goods_type type on goods.goods_type = type.id
  	where 1=1 
  	<if test="searchKeyword != null and searchKeyword != '' ">
  	 AND goods.title like concat('%',#{searchKeyword},'%')
  	</if>
  	<if test="searchType != null and searchType != '' ">
  	 AND goods.goods_type = #{searchType}
  	</if>
  	 AND goods.deleted = 0 and goods.operator_id = #{operatorId}
  </select>
  
  <!-- 查询详情 -->
  <select id="queryDetailsById" resultMap="DetailsResultMap">
  	SELECT goods.*, type.id as type_id, type.type_name as type_name FROM (SELECT <include refid="Base_Column_List" /> FROM t_goods) goods
  	left join t_goods_type type on goods.goods_type = type.id
  	where goods.deleted = 0 and goods.id = #{id} and goods.operator_id = #{operatorId}
  </select>
  <select id="getTagList" resultMap="TagResultMap"  >
	SELECT tag.id, tag.tag_name from t_goods_tag_list list 
	LEFT JOIN t_goods_tag tag on tag.id = list.tag_id
	where list.goods_id = #{goodsId}
  </select>
  
  <!-- 组合商品页签，获取供选择的商品列表 -->
  <select id="queryGoodsListForCollection" resultMap="BaseResultMap">
  	SELECT a.*  from
	(SELECT g.goods_mode as goodsMode, i.id as id, g.goods_image_url as goodsImageUrl, g.title as title, g.operator_id as operatorId from t_goods_item i 
	left JOIN t_goods g on g.id = i.goods_id
	UNION
	SELECT g.goods_mode as goodsMode, l.id as id, g.goods_image_url as goodsImageUrl, CONCAT(g.title,"+",recode.sku_name) as title, g.operator_id as operatorId from t_goods_sku_list l 
	left JOIN t_goods g on g.id = l.goods_id LEFT JOIN t_goods_sku_recode recode on l.record_id = recode.id) a where 1=1 and a.operatorId = #{operatorId}
	<if test="searchKeyword != null and searchKeyword != '' ">
  	 AND a.title like concat('%',#{searchKeyword},'%')
  	</if>
  </select>
  
  <!-- 商品分类，删除操作时，查询要删除的t_goods_type有没有被引用 -->
  <select id="getCountByDeleteIds" resultType="Integer">
  	SELECT SUM(a) as num from (
	SELECT COUNT(*) as a from t_goods_material material where material.goods_type in
	<foreach collection="deleteIds" item="item" index="index" open="(" separator="," close=")" >
   		#{item}
   	</foreach>
	UNION ALL
	SELECT COUNT(*) as a from t_goods goods where goods.goods_type in 
	<foreach collection="deleteIds" item="item" index="index" open="(" separator="," close=")" >
   		#{item}
   	</foreach>
	) as tmp
  </select>
  
  
  <!-- TMS-》调度管理-》查看货品详情 ，调用此接口获取商品信息-->
  <select id="mulGoodsInfo" parameterType="list" resultType="com.zhilianbao.erp.auth.vo.goods.facade.RspGoodsRestVo">
    SELECT goods.goods_code as goodsCode, goods.title, dict.dict_desc as skuName, type.type_name as goodsTypeName, 
	(SELECT list.property_item_value from t_goods_property_list list 
	where list.goods_id = goods.id and list.property_id = 1) as weight,
	(SELECT list.property_item_value from t_goods_property_list list 
	where list.goods_id = goods.id and list.property_id = 2) as volume,
	(SELECT list.property_item_value from t_goods_property_list list 
	where list.goods_id = 1 and list.property_id = 3) as sendMode,
	(SELECT item.property_value from t_goods_property_list list 
	LEFT JOIN t_goods_property_item item on item.property_id = list.property_id
	where list.goods_id = goods.id and list.property_id = 4 and item.id = list.property_item_value) as sizeType
	from t_goods goods 
	LEFT JOIN t_goods_type type on type.id = goods.goods_type
	LEFT JOIN t_goods_item item on item.goods_id = goods.id
	LEFT JOIN t_goods_stock stock on stock.id = item.goods_stock_id
	LEFT JOIN t_system_dict dict on dict.dict_value = stock.sale_unit 
      <where>
      	  dict.dict_type = 'goods_unit' and goods.goods_mode = 0
          <if test="list != null">
              and goods.goods_code in 
	          <foreach collection="list" item="item" open="(" close=")" separator="," index="index">
	              #{item}
	          </foreach>
          </if>
      </where>
  </select>
  
</mapper>