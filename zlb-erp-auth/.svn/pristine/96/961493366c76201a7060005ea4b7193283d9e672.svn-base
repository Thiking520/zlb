package com.zhilianbao.erp.auth.impl.goods;


import java.util.List;

import org.apache.commons.beanutils.PropertyUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.interceptor.TransactionAspectSupport;

import com.zhilianbao.erp.auth.entity.goods.GoodsPropertyListBean;
import com.zhilianbao.erp.auth.mapper.goods.GoodsPropertyListMapper;
import com.zhilianbao.erp.auth.service.goods.IGoodsPropertyListService;
import com.zhilianbao.erp.auth.vo.goods.GoodsPropertyListVo;
import com.zhilianbao.erp.common.constant.ResultEnum;
import com.zhilianbao.erp.common.vo.ResponseResult;

import tk.mybatis.mapper.entity.Example;
import tk.mybatis.mapper.entity.Example.Criteria;

/**
 * 商品与商品属性中间表
 * @Company: 智联宝 
 * @author ：chenll
 * @date ：2017年3月10日 上午10:41:07
 */
@Service
@Transactional
public class GoodsPropertyListServiceImpl implements IGoodsPropertyListService {
	
	private static Logger logger=LogManager.getLogger(GoodsPropertyListServiceImpl.class);
	
	@Autowired
	private GoodsPropertyListMapper goodsPropertyListMapper;

	@Override
	public ResponseResult<GoodsPropertyListVo> updateData(List<GoodsPropertyListVo> voList) {
		ResponseResult<GoodsPropertyListVo> rspResult = new ResponseResult<GoodsPropertyListVo>();
		try {
			if (voList == null || voList.size() <= 0){
				return new ResponseResult<GoodsPropertyListVo>(ResultEnum.SYS_ERR);
			}
			GoodsPropertyListVo skuListVo = voList.get(0);
			Long goodsId = skuListVo.getGoodsId();
			//先删t_goods_property_list
			Example skuListDeleteExample = new Example(GoodsPropertyListBean.class);
			Criteria skuListDeleteCriteria = skuListDeleteExample.createCriteria();    
			skuListDeleteCriteria.andEqualTo("goodsId", goodsId);
			goodsPropertyListMapper.deleteByExample(skuListDeleteExample);
			
			//再insert
			for(GoodsPropertyListVo vo : voList){
				GoodsPropertyListBean bean = new GoodsPropertyListBean();
				PropertyUtils.copyProperties(bean,vo);
				goodsPropertyListMapper.insertSelective(bean);
			}
		} catch (Exception e) {
			logger.error("【商品资料管理-属性信息】修改出错{}",voList, e);
			// 回滚
			TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
			return new ResponseResult<GoodsPropertyListVo>(ResultEnum.SYS_ERR);
		}
		return rspResult;
	}
}
