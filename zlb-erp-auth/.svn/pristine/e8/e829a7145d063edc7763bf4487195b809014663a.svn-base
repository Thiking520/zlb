package com.zhilianbao.erp.auth.impl.goods;


import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.beanutils.PropertyUtils;
import org.apache.commons.collections.CollectionUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.interceptor.TransactionAspectSupport;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.zhilianbao.erp.auth.entity.goods.GoodsSkuBean;
import com.zhilianbao.erp.auth.mapper.goods.GoodsSkuMapper;
import com.zhilianbao.erp.auth.service.goods.IGoodsSkuService;
import com.zhilianbao.erp.auth.vo.goods.GoodsSkuVo;
import com.zhilianbao.erp.common.constant.Constants;
import com.zhilianbao.erp.common.constant.ResultEnum;
import com.zhilianbao.erp.common.vo.ResponseResult;
import com.zhilianbao.erp.common.vo.ViewSearchVo;
/**
 * 商品规格
 * @Company: 智联宝 
 * @author ：chenll
 * @date ：2017年3月13日 下午4:38:18
 */
@Service
@Transactional
public class GoodsSkuServiceImpl implements IGoodsSkuService {
	
	private static Logger logger=LogManager.getLogger(GoodsSkuServiceImpl.class);
	
	@Autowired
	private GoodsSkuMapper goodsSkuMapper;
	
	public ResponseResult<GoodsSkuVo> queryListByPage(ViewSearchVo vo) {
		ResponseResult<GoodsSkuVo> rspResult = new ResponseResult<GoodsSkuVo>();
		try {
			// 与mysql中的limit参数一致offset,limit
			PageHelper.offsetPage(vo.getOffset(), vo.getPageSize()); // 核心分页代码 开启分页查询，后面第一条查询语句会被分页
			// 注意:如果有两条查询语句，第二条不会被分页
			List<GoodsSkuVo> list = goodsSkuMapper.queryListByPage(vo);
			if (Constants.ZERO == list.size()) {
				return new ResponseResult<GoodsSkuVo>(ResultEnum.EMPTY);
			}
			PageInfo<GoodsSkuVo> page = new PageInfo<GoodsSkuVo>(list);
			long total = page.getTotal();// 获取数据库中的总条数
			List<GoodsSkuVo> pageList = page.getList();// 推荐使用这个获取结果集
			
			if (CollectionUtils.isEmpty(pageList)) {
				return new ResponseResult<GoodsSkuVo>(ResultEnum.EMPTY);
			}
            //分页必填的两个参数
            rspResult.setTotal(total);
			rspResult.setRows(pageList);
		} catch (Exception e) {
			logger.error("【商品管理-商品规格】分页查询出错{}",vo,e);
			return new ResponseResult<GoodsSkuVo>(ResultEnum.SYS_ERR);
		}
		return rspResult;
	}
	
	@Override
	public List<Map<String, Object>> initTree(ViewSearchVo vo) {
		List<Map<String, Object>> rspResult;
		try {
			List<GoodsSkuVo> list = goodsSkuMapper.initTree(vo);
			if (CollectionUtils.isEmpty(list)) {
				return new ArrayList<Map<String, Object>>();
			}
			rspResult = buildTree(0L, list);
		} catch (Exception e) {
			logger.error("【商品管理-商品规格】初始化树结构出错{}",vo,e);
			return new ArrayList<Map<String, Object>>();
		}
		return rspResult;
	}
	
	private List<Map<String, Object>> buildTree(Long parentId, List<GoodsSkuVo> typeList) {
        List<Map<String, Object>> alists = new ArrayList<Map<String, Object>>();//父节点表
		//拼装子节点     
		for (GoodsSkuVo vo : typeList) {
			if(parentId.equals(vo.getParentId())) {
			    Map<String, Object> node = new HashMap<String, Object>();   
			    //子节点id
			    node.put("id", vo.getId().toString());
			    //节点的父节点，这里不能用parentId，在前端显示就不正确了，有可能树形控件本身有parentId属性
			    node.put("typeParentId", vo.getParentId());
			    //节点名字
			    node.put("text", vo.getSkuName());
			    
	            List<Map<String, Object>> children = buildTree(vo.getId(), typeList);
	            if(children != null && children.size() > 0)
	            	node.put("nodes", children);
	            alists.add(node);
            }
        }
        return alists;
    }
	
	@Override
	public ResponseResult<GoodsSkuVo> queryDetails(GoodsSkuVo searchVo) {
		ResponseResult<GoodsSkuVo> rspResult = new ResponseResult<GoodsSkuVo>();
		try {
			GoodsSkuVo vo = goodsSkuMapper.queryById(searchVo);
			rspResult.setData(vo);
		} catch (Exception e) {
			logger.error("【商品管理-商品规格】详情出错，id={}",searchVo.getId(), e);
			return new ResponseResult<GoodsSkuVo>(ResultEnum.SYS_ERR);
		}
		return rspResult;
	}

	@Override
	public ResponseResult<GoodsSkuVo> addData(GoodsSkuVo vo) {
		ResponseResult<GoodsSkuVo> rspResult = new ResponseResult<GoodsSkuVo>();
		try {
			GoodsSkuBean bean = new GoodsSkuBean();
			// 写父项
			PropertyUtils.copyProperties(bean,vo);
			bean.setParentId(0L);
			goodsSkuMapper.insertSelective(bean);
			
			// 写子项
			List<GoodsSkuVo> childList = vo.getChildList();
			for(GoodsSkuVo childVo : childList){
				GoodsSkuBean childBean = new GoodsSkuBean();
				PropertyUtils.copyProperties(childBean, childVo);
				childBean.setParentId(bean.getId());
				childBean.setCreator(vo.getCreator());
				childBean.setOperatorId(vo.getOperatorId());
				goodsSkuMapper.insertSelective(childBean);
			}
		} catch (Exception e) {
			logger.error("【商品管理-商品规格】新增出错{}", vo, e);
			// 回滚
			TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
			return new ResponseResult<GoodsSkuVo>(ResultEnum.SYS_ERR);
		}
		return rspResult;
	}

	@Override
	public ResponseResult<GoodsSkuVo> deleteData(GoodsSkuVo vo) {
		ResponseResult<GoodsSkuVo> rspResult = new ResponseResult<GoodsSkuVo>();
		try {
			// 删父项，判断所有子项有没有被引用
			List<GoodsSkuVo> goodsList = goodsSkuMapper.getListByParentId(vo.getId());
			Long [] deleteIds = new Long[goodsList.size()];
			for(int i = 0 ; i < goodsList.size() ; i ++){
				GoodsSkuVo tmpVo = goodsList.get(i);
				deleteIds[i] = tmpVo.getId();
			}
			if(deleteIds != null && deleteIds.length > 0){
				int count = goodsSkuMapper.getCountByDeleteIds(deleteIds);
				if(count > 0)
					return new ResponseResult<GoodsSkuVo>(ResultEnum.IN_USE);
			}
			
			GoodsSkuBean bean = new GoodsSkuBean();
			bean.setId(vo.getId());
			bean.setDeleted(true);
			goodsSkuMapper.updateByPrimaryKeySelective(bean);
		} catch (Exception e) {
			logger.error("【商品管理-商品规格】删除出错,id={}",vo.getId(), e);
			return new ResponseResult<GoodsSkuVo>(ResultEnum.SYS_ERR);
		}
		return rspResult;
	}

	@Override
	public ResponseResult<GoodsSkuVo> updateData(GoodsSkuVo vo) {
		ResponseResult<GoodsSkuVo> rspResult = new ResponseResult<GoodsSkuVo>();
		try {
			// 先判断删除的子项有没有被引用
			Long[] deleteIds = vo.getDeleteIds();
			if(deleteIds != null && deleteIds.length > 0){
				int count = goodsSkuMapper.getCountByDeleteIds(deleteIds);
				if(count > 0)
					return new ResponseResult<GoodsSkuVo>(ResultEnum.IN_USE);
			}
			
			// 改父项
			GoodsSkuBean bean = new GoodsSkuBean();
			PropertyUtils.copyProperties(bean,vo);
			goodsSkuMapper.updateByPrimaryKeySelective(bean);
			
			// 子项，可能insert，也可能update，也有可能delete
			if(deleteIds != null && deleteIds.length > 0)
				goodsSkuMapper.deleteBatchByIds(deleteIds);
			List<GoodsSkuVo> childList = vo.getChildList();
			for(GoodsSkuVo childVo : childList){
				GoodsSkuBean childBean = new GoodsSkuBean();
				PropertyUtils.copyProperties(childBean,childVo);
				if(childVo.getId() == null){
					goodsSkuMapper.insertSelective(childBean);
					childBean.setParentId(bean.getId());
				}
				else {
					goodsSkuMapper.updateByPrimaryKeySelective(childBean);
				}
			}
		} catch (Exception e) {
			logger.error("【商品管理-商品规格】修改出错{}",vo, e);
			// 回滚
			TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
			return new ResponseResult<GoodsSkuVo>(ResultEnum.SYS_ERR);
		}
		return rspResult;
	}
}
